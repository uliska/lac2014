\documentclass[11pt,a4paper]{article}
\usepackage{lac2014}
\sloppy
\newenvironment{contentsmall}{\small}

% This package contains some stylings for the CFP in its submission form.
% For any further use (e.g. in proceedings) it can safely be commented.
%\usepackage{ulCFPstyles}

\usepackage{hyperref}

\title{Version Control In Scholarly Editions}

%see lac2012.sty for how to format multiple authors!
\author
{Urs LISKA \and Janek WARCHOŁ
\\ openLilyLib.org / lilypondblog.org
\\ info@openlilylib.org
}



\begin{document}
\maketitle


\begin{abstract}
\begin{contentsmall}
A discussion of the role plain text based tools can play in the preparation of
scholarly editions. This paper is based on the authors' experience with an
edition prepared with LilyPond and \LaTeX, as well as the prospects with
another edition currently in preparation.
Focus is on collaborative workflows powered by version control -- a concept that
is to our knowledge nearly non-existent in current scholarly work,

\end{contentsmall}
\end{abstract}

\keywords{
\begin{contentsmall}
Musical engraving, scholarly editions, version control, workflows.
\end{contentsmall}
}

\section{Introduction -- Our Story}
Recently we published a revised edition of the songs of Oskar Fried (1871\,--\,1941)%
\footnote{\url{http://en.wikipedia.org/wiki/Oskar\_Fried}}.
It was realized with a small team of only two musicologists (Urs Liska and Alexander
Gurdon) and one music engraver (Janek Warchoł).
It soon turned out that the project had a larger scale than expected, mainly for two
-- independent -- reasons: the revision dug up a lot more questions than we had thought of,
and the music's complexity was a real challenge for both the notation program and the 
engraver.

Halfway through the project we decided to start using \emph{versioning} to organize
our files, and to use \LaTeX{} to compile text and scores to a contigious volume.
This turned out to be one of the most influential decisions we made in recent years,
because it made us realize that current editing workflows are bad
and how awesome is using version control for preparing music
editions, in particular how much it improves collaboration (and makes new workflows
possible). While this style of working is obvious in software development it
applies \emph{equally} to scholarly editions and engraving scores.

\section{The Problem}
So, what exactly is wrong with current music editing tools and workflows?
Well, several things:

\subsection{You Have To Be Careful}
It's easy to accidentally break something, and if you overwrite previous
good version with a bad one, you're in trouble.
Usually you can use the "undo" function, but what if the mistake happened
some time ago and was followed by legitimate changes?

Ths is magnified by opaqueness of binary file formats: your program is doing
something with them, but you cannot see what exactly, and you can easily
overlook some changes.

We used to constantly check if our edits haven't broken something,
and it was \emph{extremely} tedious and time consuming.

\subsection{There's a Lot on Your Head}
Keeping track of what changed in the project recently, who did what,
and which issues on your (usually long) \textsc{todo} list still have to be
solved, is tedious.  Especially when your critical remarks and \textsc{todo}s
are separated from the actual content.

Or maybe you had a weekly (or monthly) pause from the project.
Now you open the files again and for the first hour you're scratching your head
recalling what actually you (and other team members) were doing.


\subsection{Your Workflow Isn't Flexible}
Would you like to input music in different order?  You're out of luck,
this is something that should better be done "chronologically".
Are you working on a long piece (maybe with a short deadline) an you'd like to split the work
of entering it between several people?  You're out of luck,
because merging the work is not straightforward.
Are you working in a team and you'd like to do some edits but you have to wait
until your colleague finishes?  That's quite irritating.

work must be done in a specific order

you have to wait until some issues are finished to progress

Take into account that you often have to change documents along the way:
Editor writes critical report in Word, typesetter imports that to, say, InDesign
and has some heavy cleaning up to do. From this point on the editor can't do
\emph{anything} with the real document. Similar with scores -- if the editors work
with printouts and manual (pencil) markings. (I saw this with Schoenberg, while at
the Webern edition the editors actually prepare the score with Finale themselves,
so \emph{this} point isn't true always.)

For example, you might want to create two versions of a score:
a verbatim copy of the original manuscript, and a revised version.
With current tools, you have to finish first version before starting
any work on the revision -- so, if any interesting ideas occur to you
while entering the raw material, you cannot incorporate them immediately.

\subsection{Some Things Are Just Pain in the ...}
Maybe you're working with a piece for which multiple sources exist,
and you'd like to create multiple versions showing w

Then you discover a typo and have to fix it twice.


and when you want to send some usable version to someone
(but you're right in the middle of making some change)
you don't have anything to send.

\subsection{Underlying causes}
there are two:
- no built-in way to track your progress and changes
- no way to do the work in parallel or to change the order of your work, 
which is caused by the fact that your cannot reasonably merge parallel versions.


\section{The Solution}

\subsection{Version Control}
\emph{Version control} is a bread-and-butter concept for any software developer, but the
interesting point is that it can be made equally fruitful for scholarly work and music
engraving. Version control keeps track in detail about \emph{all} that is happening during
the development of a project. And in particular it allows an arbitrary number of contributors
to work on an arbitrary number of files \emph{at the same time} without problems.


\subsection{Plain text}
Version control performs its work on plain text files because it relies on the 
line-by-line comparison of files. While this may seem a restriction it is also the
foundation of the versioning magic -- conflicts may not arise when two people edited the
same \emph{file} but only when they edited the same \emph{line}!

\subsection{What Do You Need?}
As mentioned version control works on plain text files. So in order to benefit from versioned
workflows you need to work with tools processing plain text files%
\footnote{Please note that \textsc{xml} file formats \emph{are} plain text files
but less practical for version control. So while it is possible to use versioning on
OpenOffice or MS Office \textsc{xml} files it isn't really useful in our opinion.}
. From our experience
using LilyPond for engraving scores and \LaTeX{} for typesetting texts is a perfect
combination because these two also offer excellent performance in their respective domains.
All tools that are needed are available as Open Source software, and most of them can
be used on any operating system.

\subsection{Does it really work?}
Editing plain text files may seem daunting and “nerdy”, so it may be a valid question
if it really works out and is worth the trouble. But we can assure you it \emph{is} worth
the investment of time as the advantages that versioned workflows offer are fundamental.
We hope to make this obvious in this paper.

Before we switched to version control Janek wrote in a note: \emph{never beautify more than 2
songs at once}. This wasn't for any specific theoretical reason but because he realized
that more would simply be unmanageable without opening the door wide for fatal
conflicts.

After the switch we were working on up to 26 songs in parallel and at different topics
(e.\,g. proof-reading and beautification) while being completely confident not to
mess up anything.

Versioning enables collaboration at an incredible pace -- you can work on a document
simultaneously, chat in parallel and update your versions every
few minutes. Actually that's how we finished this paper.


\medskip
\hrule

\medskip
The rest of this paper is a rather personal report of our experiences with the Fried
edition, explaining in detail how all this worked for us.  It also contains
some comments on a project we're currently starting, and which is intended to become
a reference project for \emph{crowd engraving}, a more or less unknown concept that is
originally made possible by version control. We also wrote a number of blog posts on
\emph{Scores of Beauty}%
\footnote{\url{http://lilypondblog.org/category/fried-songs}}
which you may enjoy as additional reading.

\section{How does it work?}
Urs has written an extensive essay on the subject%
\footnote{\url{http://lilypondblog.org/2013/07/plain-text-files-in-music/}}
so we can keep the general summary concise and concentrate on some specific stuff
about our collaborative experiences.

\subsection{Version Control}
The possibility to maintain plain text files under \emph{version control} is on of
their most important aspects. Using version control for engraving and editing music
opens a full range of collaborative workflows.

\paragraph{Undo/Redo}
On a very basic level you may understand version control as an infinitely flexible
implementation of \emph{undo/redo} mechanisms. But different from the tools you will
know from most programs this isn't restricted to chronologically undoing steps one by
one. By contrast versioning allows you to inspect, revert or modify \emph{any} state
individually.

\paragraph{Line-by-line Comparison}
The foundation of version control is the ability to compare a project directory's (also
known as \emph{repository}) content \emph{line by line} and detect modifications on line
level. This is also the reason why versioning only works on plain text files.
Any modifications done during one editing session are packed as a \emph{changeset} and
can be accessed as a unit.

\paragraph{Project History}
The sum or chain of all changesets in a repository forms its \emph{history}. A user can 
at any time inspect any changeset, revert or modify it, or she can set the whole project
to that given state. This makes it possible to retrace the steps of a project.

\paragraph{Branching}
In a versioned project it is possible to work in \emph{branches}, which can be
understood as a kind of separate working sessions. Work done on one branch doesn't affect
work on other branches. So the main line of the project can always be kept in a consistent
state.

\subsection{Plain Text Files}
Plain text file formats are fundamentally different from binary file formats often
used by graphical \textsc{wysiwyg} programs. They have characteristics which we consider fundamentally superior. The key aspects are:

\paragraph{Mergeability:}
This is the key property, because it makes version control work.

\paragraph{Transparency:}
Plain text files reveal every aspect of their content, everything is explicitly written
and readable. Anybody can inspect it and see what has been entered and if and how it is
manually tweaked.

Binary files are opaque and conceal how they manage your input. They can only be
interpreted by their original programs or by programs that have specific input filters.

\paragraph{Separation of concerns:}
The explicit nature of plain text files provides a clean separation of content, meaning
and appearance. Through the use of explicit commands the content
of a document is clearly marked up semantically while this \emph{meaning} is completely
independent from its visual \emph{appearance}.

\paragraph{Readability and Stability:}
Plain text files are human readable, binary files are not. This simple statement has
considerable implications. Plain text files can be recovered to a much greater extent
than binary files after being damaged. And they are (at least conceptually) much better
equipped for evolution of applications and operating systems.

\paragraph{Editor independence:}
Plain text tools separate the tasks of editing, processing and displaying documents,
making it possible to choose different tools for different tasks. Plain text files
can principally be edited with \emph{any} text editor, which opens a wide array of
workflow options, for example editing on smartphones or through web interfaces.

\section{Structuring the Project}

\subsection{Libraries}
Plain text file formats provide ways to reference variables or custom
commands and to store these in files that can be included from the
main files. This way one can create libraries of project-wide code
that make the the project consistent. Style sheets and commands are
maintained on a global level, and any modifications automatically
affect all documents or scores.

\subsection{Programming}
Plain text tools like LilyPond and \LaTeX{} offer a level of programmability that
goes beyond usual scripting interfaces (like e.\,g. VBA). Commands may simply apply
some formatting or perform complex operations on multiple arguments.
Programming is a useful method to enforce, say, typographic consistence, but it can
also be used to “handle data”.

One interesting use of these possibilities is to create different output for work and for
publication. Elements can be highlighted through coloring (e.\,g. editorial additions)
or laid out completely differently (e.\,g. the entries for the critical report) to be
more practical to use while still in the editing process.

\subsection{Mix Music and Text}
LilyPond and \LaTeX{} are a perfect match for creating scholarly editions. \LaTeX{}
provides several convenient ways of professionally incorporating scores or music examples,
by now there is \texttt{lilyglyphs}%
\footnote{\url{http://ctan.org/pkg/lilyglyphs}}
available to include \emph{any} notational symbols in continuous text -- and both
can be maintained under version control.

Using \texttt{make} can be a convenient tool to automatically produce a newly compiled
volume when individual scores have changed -- or to enforce unit tests before merging
new work.

\section{Collaboration}\label{sec:collaboration}
A basic and commonly used way to collaborate on documents is sharing them by email.
While this may seem convenient it yields severe risks. While in former times physical
copies had been sent around, nowadays you can create numerous virtual copies of
the documents, and avoiding conflicts through simultaneous editing can
become very complex. Using some shared location on a server is definitely an improvement
because collaborators edit the same files. Nevertheless this requires careful file locking
strategies and becomes hardly manageable with three-digit numbers of files and more than
two collaborators.

This is where managing the project with version control%
\footnote{Git (\url{http://git-scm.com}) is one of many available version control systems.
If in doubt any terms in this paper refer to Git's usage.}
comes into play.

\subsection{Distributed Work}
In a \textsl{distributed VCS} (version control system), every collaborator
has a local copy of the complete repository and can work freely on that.
Contacting the repository on the server is only necessary to synchronize by downloading
others' work, merging it with one's own and uploading the result.

As this merging is performed based on line-by-line comparison chances of running into
conflicting situations are rather small. And \emph{if} they should occur there are
straightforward ways to recover from the situation. Therefore it is possible to edit files
\emph{simultaneously}, without any need for “locking” files or similar workflow
restrictions. This and the concept of the history allows multiple editors to work freely without the risk of stepping on each other's toes. 

\subsection{Editor and Engraver}
% It is actually a hot topic in scholarly discussion
% to what extent the editor should also be an engraver.
% Scholarly editions usually let the editor only provide
% a model, while an engraver from the publishe prepares the
% score. By contrast commercial publishers usually require
% the editor to prepare a near-printable score document.
Traditionally the tasks of the editor and the engraver were completely separated: the
editor somehow prepared an \emph{engraver's copy}, the engraver engraved a metal plate,
the editor did proof-reading, and the engraver finished the plates. In some contexts
this is still common practice, particularly with scholarly edition institutes, whose
editors often don't do any engraving at all. On the other hand many commercial
publishers expect the editor to deliver (nearly) print-ready files that can be
finished in-house with minimal effort (and investment). However, all of these workflows
share the fact that files (or plates) have to be passed around, with strict
“locking strategies” in order to avoid data loss or conflicting situations. If an editor
notices a wrong note she can't simply fix it in the score file but has to send the
engraver an email asking him to apply the fix etc.

In a workflow based on plain text tools and versioning this is \emph{completely} different.
Everybody works on the same shared data repository and has full access to any file at any
time%
\footnote{We don't want to say that role-based privileges aren't useful in many cases
but want to stress the principal possibility here.}.
Each collaborator can apply any modification because 
\mbox{\emph{a)} this} won't compromise or lose data and
\mbox{\emph{b)} any} modification is meticulously documented in the changesets.
Particularly the latter aspect is important for the new workflow experience. If someone
else edits a file I can see precisely what he did and when (so it's possible to say
“Editor A fixed that pitch on Jan 23”, for example). And if \emph{I} edit files I can
do this without hesitation, because I know the others can immediately see the changes
and object to them if necessary.

One consequence of these possibilities is that the tasks and responsibilities of
(scholarly) editor and engraver can and will blur to some extent. If everybody has
permanent access to the complete data repository tasks don't have to be separated as
strictly as formerly. This makes a lot of sense because there usually are considerable
intersections of skillsets. Urs as the scholarly editor \emph{does} have strong sense
for typography, and Janek as the engraver \emph{does} have a sharp eye on details, so
he'll notice issues with the musical text too. In a versioned workflow both can do
as much of the other's task as both like and time allows, improving efficiency but also
the quality of the result. We think this option can have significant impact in today's
discussion of the relation between editor and engraver or editor, edition institute and
(commercial) publisher.

When preparing our edition of Oskar Fried's songs this really boosted our work. Being
able to inspect the other's work, to freely apply edits and not the least to encapsulate
work in branches made us work much more straightforwardly. While we had to be
extremely careful when still managing the Dropbox folder we could now just start working
on any given issue. Sharing ideas and reviewing each other's work proved very inspiring
and presumably raised the overall quality of our work. We wrote this several times, and
it may sound like a buzz-phrase, but it's literally true: We can't imagine how we could
have worked without these tools in our “earlier lives”.

Particularly the last phase of the project was very revealing. We had to do our final
proof-reading round after the scores were finished from the typographical perspective.
(Well, this was partly due to suboptimal planning on our part, but one will have this
situation nearly always to some extent.) Modifying a score that has already been tweaked
to perfection is a very delicate task because any change of the musical text can
severly mess up the layout. Fortunately LilyPond performed extremely well in this regard%
\footnote{\url{http://lilypondblog.org/2013/11/modifying-already-beautified-scores/}},
but version control made the process less daunting by magnitudes.
Urs applied fixes to the errors that he and his fellow musicologist found himself (instead
of having to ask Janek to do so) and wrapped each single edit in an individual \emph{commit}%
\footnote{“Commit” is Git's term for a changeset.},
using the commit message as a convenient place to document his opinion on the necessity of
typographic follow-up fixes. Janek could then inspect the chain of messages so he
immediately knew where to look particularly carefully. This ensured that no unintended
side-effect of edits would go unnoticed, making us quite relaxed as soon as we realized
that it really worked out. This situation even allowed Urs to apply or at least prepare
typographic fixes himself, knowing he didn't irreversibly mess anything up and that Janek
could easily identify and revert any change.
Maybe even more important was the fact that we could wrap all this work in separate branches.
The edition comprises 26 songs, and as all of them were handled in individual branches
we could freely work on whichever song was currently convenient, switching context at
will. Urs created a branch for any given song and added only the relevant commits to it.
When ready with that he handed the torch to Janek who would then check everything and
finally merge this branch to the main line again. This way we \emph{always} had the project
as a whole in a consistent state and were able to juggle our tasks around without and fear
and hesitation.

\subsection{Maintainability After Publication}
One more aspect to using plain text tools is also based on the meticulous documentation
of the project history. If the source code is written decently from the start it is
\emph{very} straightforward to maintain a project even after the initial publication.
As each fix or improvement will be stored in a changeset you can apply any changes
without messing up anything. There will always be a detailed record about which
changes have been added since publication, or between any given two prints. This is
particularly interesting with today's printing-on-demand strategies where new “runs”
may be “released” after only a few copies.


\subsection{Integrating Text and Music}
\textbf{TODO:} Should we have a chapter on LaTeX or not?\\
Actually it doesn't substantially add anything to the collaboration point,
but of course it adds to the general advantages for creating editions.

\subsection{Miscellaneous Tools}
Apart from version control and plain text based programs there are several tools that
can be used to enhance the “collaborative experience”.

\paragraph{Version Control Service Providers}
While you can run a version control system on your own server there are several online service providers offering useful tools. In addition to plain data exchange they
provide convenient web interfaces that \emph{can} simplify your life even more.

Of course you will often want to edit your files in dedicated editing environments, but
it \emph{is} a very nice feature to apply small edits to files through the web interface
of a service provider. You can do a quick fix sitting in an internet café etc.

One particularly useful concept in that context are \emph{forks} and \emph{pull requests}.
They can be used perfectly to organize peer review workflows by allowing work to be
integrated to the main line only after review through people with appropriate privileges.
Read more about this in \ref{sec:proof-reading-and-peer-review} on page \pageref{sec:proof-reading-and-peer-review}.

\paragraph{Issue Trackers}
In software development projects it is a matter of course to use \emph{issue trackers.}
These tools \emph{keep track} of tasks, issues or bugs, helping you not to lose important
tasks along the way. Of course this is also a good idea for scholarly editions. Issue
trackers can be used to assign issues to people, or categorize and prioritize tasks.
They can be very valuable for relentlessly insisting on perfection.

\paragraph{List service providers}
There are services offering project management through a list metaphor%
\footnote{There are many different providers and concepts, so we only mention the one
\emph{we} used: \url{https://trello.com}}.
They use “cards” as their interface that are arranged on boards one way or another.
Similar to issue trackers you can assign items to people, comment on and discuss them and
finally mark them as “done”.

In contrast to issue trackers these services are usually more “agile” and easy to use, as
they usually display many cards at once and offer realtime collaboration with other
team members. But the drawback of this agility is that it is also volatile. If the project
requires reliable archiving of past events and issue, list apps usually aren't first choice.

\medskip
Apart from these tools there are the options to use good old email as a communication channel, mailing lists and forums. Each solution has their merits and problems, very often both are related to the same issues: Documentation and Access


\section{Crowd Editing}
In the previous section we've talked about the positive impact that version control
has on the conception of collaborative work. While we were actually two people
working together this concept can easily be extended to a larger number of people
involved. Apart from improving traditional editing workflows this can be used to create a
completely new approach to editing scores which we'd give the buzz-phrase \emph{crowd
editing}. If any number of people can participate in a project under version control
this can easily be exploited to distribute the work among a “crowd” of contributors.
Different from the concept of having distinct roles that tend to blur through the
collaborative approach there can be numerous people doing essentially the same kind
of work in parallel, effectively “clustering” manpower. While we're convinced that
in most cases it won't make sense to rely completely on the swarm intelligence (so
you should still have a firm project leadership) and that this won't reduce the
absolute number of hours spent on a project, it can significantly reduce the overall
delivery time by distributing these hours to be done in parallel.

\subsection{Music entry}
Music entry is a field that can straightforwardly be distributed among a large number
of contributors. Essentially all you need to make this a reliable process is a usable
communictaion infrastructre to avoide duplicate work.
Appropriate tools for this are assignments that can be done in issue trackers or on
virtual cards like on a Trello board. This way the whole material can be
effectively divided through the number of available contributors.

\subsection{Proof-reading and Peer Review}\label{sec:proof-reading-and-peer-review}
Version control encourages peer review workflows on all stages of a project's lifecycle.
It is not necessary to wait for peer review until work is more or less finished, but it
can be an integral part of the whole development process instead. A natural place to hook
in is when merging working branches into the main line. For example one can require the
merge to be done by a different collaborator than the one who did the work. For music entry
it would for example be appropriate to enter a certain amount of music and then ask someone
else to review and merge it.
This ensures that only reviewed material goes into the project right from the
start. While this won't make a final proof-reading obsolete it will definitely improve
the overall quality of the result.

Online services like Github or Bitbucket provide \emph{pull requests} as a very convenient
tool for this concept. Whenever a branch has changed one can open a pull request as a
publicly visible announcement that would like changes to be incorporated into the main line.
The pull request can then be inspected, discussed, modified and finally merged or rejected.

\subsection{“Das Trunkne Lied”}
This year we will prepare performance material for “Das Trunkne Lied” by Oskar Fried%
\footnote{\url{http://lilypondblog.org/2013/06/das-trunkne-lied/}}.
This is a really large score for soloists, choir and orchestra, and it will be a
huge reference project for our new workflow. Of course we intend to document it
and exploit it from a theoretical perspective too.

One noteworthy concept is that we split the whole score in tiny segments, each comprising
music from one part, covering the range of one rehearsal mark. Anybody entering or
reviewing music will be facing a rather small file with only this amount of music.
Clever programming (on the “admin's” part) generates a little score from this segment, so
the editor can always work with a very small amount of music. This makes it much more
manageable than working in the context of a huge score -- and it saves huge amounts of
compiling time.\\
On the other hand one can always compile a complete part or the full score, and LilyPond
will grab all segments that have already been entered and injects them into an otherwise
complete but empty score.

\section{Conclusions}\label{sec:conclusions}

Concluding text.

As a final comment mention that we finished this paper in real-time collaboration.


\subsection{Extending the Tools With Musicological Perspective}
% I'm not sure if this section will remain in the paper.
% It's slightly OT and might eat up too much space,
% OTOH I wouldn't want to miss it completely.
% Maybe only a short subsection here with \paragraphs instead
% of real sectioning commands

\subsubsection{Graphical Editing for Frescobaldi}

\subsubsection{\texttt{\textbackslash annotate}}

\subsubsection{Embracing Music Encoding}



\section{Acknowledgements}

Our thanks go to \ldots .

\end{document}
